// ContractGuard AI — Prisma Schema
// Mirrors the SQL migrations in src/db/migrations/
// This schema coexists with the existing raw pg queries.

generator client {
  provider        = "prisma-client"
  output          = "../src/generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [uuid_ossp(map: "uuid-ossp"), vector]
}

// ──────────────── Organizations ────────────────

model Organization {
  id                     String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name                   String
  subscription_tier      String   @default("free")
  stripe_customer_id     String?  @unique
  stripe_subscription_id String?  @unique
  created_at             DateTime @default(now()) @db.Timestamptz()
  updated_at             DateTime @default(now()) @updatedAt @db.Timestamptz()

  members   OrgMember[]
  contracts Contract[]
  alerts    Alert[]
  ai_usage  AiUsage[]

  @@map("organizations")
}

// ──────────────── Organization Members ────────────────

model OrgMember {
  org_id    String   @db.Uuid
  user_id   String   @db.Uuid
  role      String   @default("member")
  joined_at DateTime @default(now()) @db.Timestamptz()

  organization Organization @relation(fields: [org_id], references: [id], onDelete: Cascade)

  @@id([org_id, user_id])
  @@index([user_id], map: "idx_org_members_user_id")
  @@index([org_id], map: "idx_org_members_org_id")
  @@map("org_members")
}

// ──────────────── Contracts ────────────────

model Contract {
  id               String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  org_id           String    @db.Uuid
  uploaded_by      String    @db.Uuid
  name             String
  type             String
  counterparty     String?
  status           String    @default("processing")
  file_path        String
  file_size        Int
  file_type        String
  raw_text         String?
  effective_date   DateTime? @db.Date
  expiration_date  DateTime? @db.Date
  auto_renewal     Boolean?  @default(false)
  risk_score       Int?
  summary          String?
  created_at       DateTime  @default(now()) @db.Timestamptz()
  updated_at       DateTime  @default(now()) @updatedAt @db.Timestamptz()
  last_analyzed_at DateTime? @db.Timestamptz()

  organization Organization        @relation(fields: [org_id], references: [id], onDelete: Cascade)
  clauses      ContractClause[]
  embeddings   ContractEmbedding[]
  alerts       Alert[]

  @@index([org_id], map: "idx_contracts_org_id")
  @@index([status], map: "idx_contracts_status")
  @@index([risk_score], map: "idx_contracts_risk_score")
  @@index([org_id, status], map: "idx_contracts_org_status")
  @@map("contracts")
}

// ──────────────── Contract Clauses ────────────────

model ContractClause {
  id               String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contract_id      String   @db.Uuid
  clause_type      String
  text             String
  page_number      Int?
  risk_level       String   @default("low")
  risk_explanation String?
  created_at       DateTime @default(now()) @db.Timestamptz()

  contract Contract @relation(fields: [contract_id], references: [id], onDelete: Cascade)

  @@index([contract_id], map: "idx_clauses_contract_id")
  @@index([clause_type, risk_level], map: "idx_clauses_type_risk")
  @@index([risk_level], map: "idx_clauses_risk_level")
  @@map("contract_clauses")
}

// ──────────────── Contract Embeddings ────────────────

model ContractEmbedding {
  id          String                   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contract_id String                   @db.Uuid
  chunk_text  String
  chunk_index Int
  chunk_hash  String
  embedding   Unsupported("vector(768)")
  created_at  DateTime                 @default(now()) @db.Timestamptz()

  contract Contract @relation(fields: [contract_id], references: [id], onDelete: Cascade)

  @@unique([contract_id, chunk_hash], map: "idx_embeddings_chunk_hash")
  @@index([contract_id], map: "idx_embeddings_contract_id")
  @@map("contract_embeddings")
}

// ──────────────── Alerts ────────────────

model Alert {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  org_id        String    @db.Uuid
  contract_id   String    @db.Uuid
  alert_type    String
  message       String
  trigger_date  DateTime  @db.Date
  status        String    @default("pending")
  is_read       Boolean   @default(false)
  snoozed_until DateTime? @db.Date
  created_at    DateTime  @default(now()) @db.Timestamptz()
  updated_at    DateTime  @default(now()) @updatedAt @db.Timestamptz()

  organization Organization @relation(fields: [org_id], references: [id], onDelete: Cascade)
  contract     Contract     @relation(fields: [contract_id], references: [id], onDelete: Cascade)

  @@unique([contract_id, alert_type, trigger_date], map: "idx_alerts_unique_trigger")
  @@index([org_id], map: "idx_alerts_org_id")
  @@index([contract_id], map: "idx_alerts_contract_id")
  @@map("alerts")
}

// ──────────────── AI Usage ────────────────

model AiUsage {
  org_id      String   @db.Uuid
  date        DateTime @default(now()) @db.Date
  tokens_used BigInt   @default(0)
  cost_usd    Decimal  @default(0) @db.Decimal(10, 4)
  api_calls   Int      @default(0)

  organization Organization @relation(fields: [org_id], references: [id], onDelete: Cascade)

  @@id([org_id, date])
  @@index([org_id, date(sort: Desc)], map: "idx_ai_usage_org_date")
  @@map("ai_usage")
}
